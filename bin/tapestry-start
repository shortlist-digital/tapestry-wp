#!/usr/bin/env node

const fs = require('fs-extra')
const path = require('path')
const cluster = require('cluster')
const log = require('../src/utilities/logger').log
const cwd = process.cwd()
const env = 'production'

const serverPath = path.resolve(cwd, '.tapestry/server.js')
// detect scripts have been created before running server
if (!fs.existsSync(serverPath)) {
  log.error('Tapestry scripts missing, make sure to run tapestry build before running')
  process.exit(0)
}
// require server and boot
const server = require(serverPath).default
if (process.env.ENABLE_CLUSTER && cluster.isMaster) {
  const numWorkers = require('os').cpus().length;
  for(let i = 0; i < numWorkers; i++) {
    cluster.fork()
  }

  cluster.on('online', function(worker) {
    console.log('Tapestry Worker ' + worker.process.pid + ' is online')
  })

  cluster.on('exit', function(worker, code, signal) {
    console.log('Tapestry Worker ' + worker.process.pid + ' died with code: ' + code + ', and signal: ' + signal)
    console.log('Starting a new worker')
    cluster.fork()
  })
} else {
  server({ cwd, env })
}
