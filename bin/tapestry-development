#!/usr/bin/env node
require('babel-register')

const path = require('path')

const Webpack = require('webpack')
const WebpackDevServer = require('webpack-dev-server')
const createCompilers = require('../dist/create-compilers')
const cwd = process.cwd()
const env = 'development'
const log = require('../dist/logger')
const notify = log.notify

notify('Starting Webpack Hot Reload Server\n')

const indexFilePath = path.resolve(
  __dirname,
  '../',
  'src',
  'webpack',
  'index.html'
)

// create webpack node compilers
const {
  devCompiler
} = createCompilers({ cwd, env })

const cmsTarget = process.argv[2]

if (!cmsTarget) {
  return console.error('Usage: tapestry http://cms.url.com')
}

const server = new WebpackDevServer(devCompiler, {
	stats: {
		colors: true
  },
  hot: true,
  publicPath: '/_scripts/',
  proxy: {
    '/api/v1/**': {
      target: cmsTarget,
      changeOrigin: true,
      secure: false,
      pathRewrite: {
        '^/api/v1': '/wp-json/wp/v2'
      }
    }
  },
  setup: (app) => {
    app.get(/^(?!\/api\/|\/public\/|\/_scripts\/).+/, (req, res) => {
      res.sendFile(indexFilePath)
    })
  }
})

server.listen(8080, '127.0.0.1',() => {
	console.log('Tapestry Hot Dev Server started on http://localhost:8080')
})

